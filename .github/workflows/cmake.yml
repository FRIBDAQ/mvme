name: C/C++ CI

on: [push]

jobs:
  build-debian-bullseye:

    runs-on: ubuntu-latest

    container:
      image: debian:bullseye
      options: --privileged

    steps:
    - uses: actions/checkout@v1
    - name: prepare
      run: apt-get update &&
           apt-get install -y
             git make gcc g++
    - name: submodules
      run: git config --global --add safe.directory '*' &&
           git submodule update --init
    - name: apt-get_1
      run: apt-get update &&
           apt-get install -y wget software-properties-common
    - name: linuxdeployqt
      run: | 
        wget -c https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
        chmod a+x linuxdeployqt-continuous-x86_64.AppImage
        mv linuxdeployqt-continuous-x86_64.AppImage /usr/local/bin/linuxdeployqt
    - name: apt-get_2
      run: apt-get update &&
           apt-get install -y
                    bash build-essential git cmake ninja-build ca-certificates
                    qtbase5-dev qtbase5-dev-tools libqt5websockets5-dev libqt5opengl5-dev libqt5svg5-dev
                    libqt5serialport5-dev libqwt-qt5-dev libquazip5-dev libusb-dev zlib1g-dev libgraphviz-dev
                    libboost-dev sphinx-common sphinx-rtd-theme-common python3-sphinx python3-sphinxcontrib.qthelp
                    texlive-latex-base texlive-latex-extra texlive-latex-recommended latexmk texlive-fonts-recommended
                    libzmq3-dev fuse3 kmod
    - name: modprobe
      shell: bash
      run: /sbin/modprobe fuse
    - name: configure
      run: mkdir build && cd build && cmake -DCMAKE_BUILD_TYPE=Release -DMVME_CPACK_USE_LINUXDEPLOYQT=on ..
    - name: build
      run: cmake --build build -j 4
    - name: test
      run: cd build && ctest
    - name: install
      run: cd build && make install
    - name: packaging_2
      run: cd build && cpack -g TBZ2
    - name: uploading_2
      uses: actions/upload-artifact@v4
      with:
        name: test2
        path: ./*.tbz2
    - name: uploading_3
      uses: actions/upload-artifact@v4
      with:
        name: test3
        path: ./build/*.tbz2
